---
title: "Model2_Zuocheng"
author: "Zhang"
date: "2025-04-24"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r Warning=FALSE}
library(readxl)
library(openxlsx)
library(dplyr)
library(lubridate)
library(ggplot2)
library(forecast)  
library(Kendall)
library(tseries)
library(outliers)
library(tidyverse)
library(smooth)
library(zoo)
library(kableExtra)
library(timeDate)
library(glmnet)

set.seed(1111)
```


# Import Data

```{r}

#Importing daily data
daily_data <- read.csv(file="../data/processed/processed_daily_data.csv", header=TRUE)


```

# Get features

```{r}

# Get the date
daily_data$date <- as.Date(daily_data$date)

us_years <- as.numeric(format(daily_data$date, "%Y"))

us_holidays <- holidayNYSE(unique(us_years))


Sys.setlocale("LC_ALL", "C")


daily_data <- daily_data %>%
              mutate(lag1 = lag(daily_data$load_daily,1),
                     lag2 = lag(daily_data$load_daily,2),
                     volatility_3d = rollapply(daily_data$load_daily, width = 3, FUN = sd, align = "right", fill = NA),
                     volatility_7d = rollapply(daily_data$load_daily, width = 7, FUN = sd, align = "right", fill = NA))  %>%
  mutate(is_weekend = as.integer(weekdays(date) %in% c("Saturday", "Sunday"))) %>%
  mutate(quarter = quarter(date),
         is_us_holiday = as.integer(date %in% as.Date(us_holidays))) %>%
  drop_na()



library(zoo)

daily_data <- daily_data %>%
  mutate(
    rolling_mean_7 = rollapply(load_daily, width = 7, FUN = mean, align = "right", fill = NA),
    rolling_mean_14 = rollapply(load_daily, width = 7, FUN = mean, align = "right", fill = NA),
    rolling_mean_28 = rollapply(load_daily, width = 7, FUN = mean, align = "right", fill = NA),
    rolling_sd_7 = rollapply(load_daily, width = 7, FUN = sd, align = "right", fill = NA),
    rolling_sd_14 = rollapply(load_daily, width = 7, FUN = sd, align = "right", fill = NA),
    rolling_sd_28 = rollapply(load_daily, width = 7, FUN = sd, align = "right", fill = NA),
  )


daily_data$rolling_trend_7 <- rollapply(
  daily_data$load_daily, 
  width = 7, 
  align = "right", 
  fill = NA,
  FUN = function(x) {
    model <- lm(x ~ seq_along(x))
    coef(model)[2] 
  }
)

daily_data <- daily_data %>%
  mutate(
    temp_lag_0 = temperature_daily_ts,
    temp_lag_1 = lag(temperature_daily_ts, 1),
    temp_lag_2 = lag(temperature_daily_ts, 2),
    temp_lag_3 = lag(temperature_daily_ts, 3)
  )

daily_data <- daily_data %>%
  mutate(
    humi_lag_0 = humidity_daily_ts,
    humi_lag_1 = lag(humidity_daily_ts, 1)
  )

daily_data <- daily_data %>% drop_na()


```

# Transform to ts

```{r}

msts_load_daily <- msts(daily_data, 
                           seasonal.periods =c(7,365.25),
                           start=c(2005,01,01))

total_length <- length(msts_load_daily[,1])


test_length <- 365


train_set <- window(msts_load_daily, end = c(2005 + (total_length - test_length - 1)/365.25))
test_set <- window(msts_load_daily, start = c(2005 + (total_length - test_length)/365.25))


```

# NN Model

# Test Performance

```{r}

variable <- c(9:11)

xreg_train <- cbind(fourier(train_set[,"load_daily"],K=c(2,6)), train_set[,variable])
xreg_test  <- cbind(fourier(test_set[,"load_daily"] ,K=c(2,6) , h=length(test_set[,"load_daily"])), test_set[,variable])




NN_fit <- nnetar(train_set[,"load_daily"], xreg = xreg_train, size=7)
NN_for <- forecast(NN_fit, xreg = xreg_test, h=length(test_set[,1]))

forecast_NN_accuracy <- accuracy(NN_for$mean, test_set[,"load_daily"])

print(forecast_NN_accuracy)

plot(NN_for)

```

# Real-time prediction

```{r}

res <- predict_future_xreg(msts_load_daily, variable, h=59)


fourier_future <- fourier(msts_load_daily[,"load_daily"], K=c(2,6), h=59)

xreg_future <- cbind(fourier_future, res)


NN_future <- forecast(NN_fit, xreg = xreg_future, h = 59)


#### Test

fourier_future <- fourier(test_set[,"load_daily"], K=c(2,6), h=length(test_set[,1]))

xreg_future <- cbind(fourier_future, test_set[,variable])


NN_future <- forecast(NN_fit, xreg = xreg_future, h = 59)

temp <- NN_future$mean

```
# Save

```{r}

output <- NN_future$mean

output <- NN_future$mean[1:59]

template <- read_excel("../result/submission_template.xlsx")

template$load[1:length(output)] <- as.numeric(output)

write.csv(template, file = "../result/NN_with_features V5.csv",row.names = FALSE)



```
























---
title: "Model2_Zuocheng"
author: "Zhang"
date: "2025-04-24"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r Warning=FALSE}
library(readxl)
library(openxlsx)
library(dplyr)
library(lubridate)
library(ggplot2)
library(forecast)  
library(Kendall)
library(tseries)
library(outliers)
library(tidyverse)
library(smooth)
library(zoo)
library(kableExtra)
library(timeDate)
library(glmnet)

set.seed(1111)
```


# Import Data

```{r}

#Importing daily data
daily_data <- read.csv(file="../data/processed/processed_daily_data.csv", header=TRUE)


```

# Get features

```{r}

# Get the date
daily_data$date <- as.Date(daily_data$date)

us_years <- as.numeric(format(daily_data$date, "%Y"))

us_holidays <- holidayNYSE(unique(us_years))


Sys.setlocale("LC_ALL", "C")


daily_data <- daily_data %>%
              mutate(lag1 = lag(daily_data$load_daily,1),
                     lag2 = lag(daily_data$load_daily,2),
                     volatility_3d = rollapply(daily_data$load_daily, width = 3, FUN = sd, align = "right", fill = NA),
                     volatility_7d = rollapply(daily_data$load_daily, width = 7, FUN = sd, align = "right", fill = NA))  %>%
  mutate(is_weekend = as.integer(weekdays(date) %in% c("Saturday", "Sunday"))) %>%
  mutate(quarter = quarter(date),
         is_us_holiday = as.integer(date %in% as.Date(us_holidays))) %>%
  drop_na()




```

# Transform to ts

```{r}

msts_load_daily <- msts(daily_data, 
                           seasonal.periods =c(7,365.25),
                           start=c(2005,01,01))

total_length <- length(msts_load_daily[,1])


test_length <- 365


train_set <- window(msts_load_daily, end = c(2005 + (total_length - test_length - 1)/365.25))
test_set <- window(msts_load_daily, start = c(2005 + (total_length - test_length)/365.25))


```

# NN Model

# Test Performance

```{r}

variable <- c(5:11)

xreg_train <- cbind(fourier(train_set[,"load_daily"],K=c(2,6)), train_set[,variable])
xreg_test  <- cbind(fourier(test_set[,"load_daily"] ,K=c(2,6) , h=length(test_set[,"load_daily"])), test_set[,variable])




NN_fit <- nnetar(train_set[,"load_daily"], xreg = xreg_train, p = 0, P = 1)
NN_for <- forecast(NN_fit, xreg = xreg_test, h=length(test_set[,1]))

forecast_NN_accuracy <- accuracy(NN_for$mean, test_set[,"load_daily"])

print(forecast_NN_accuracy)

plot(NN_for)

```

# Real-time prediction

```{r}

res <- predict_future_xreg(msts_load_daily, variable, h=59)


fourier_future <- fourier(msts_load_daily[,"load_daily"], K=c(2,6), h=59)

xreg_future <- cbind(fourier_future, res)


NN_future <- forecast(NN_fit, xreg = xreg_future, h = 59)



```
# Save

```{r}

output <- NN_future$mean

template <- read_excel("../result/submission_template.xlsx")

template$load[1:length(output)] <- as.numeric(output)

write.csv(template, file = "../result/NN_with_features V5.csv",row.names = FALSE)



```


























# Function

```{r}

predict_future_xreg <- function(train_set, variables, h, freq = 365.25) {
  # train_set: 数据框或矩阵，包含你所有训练数据（含这些变量）
  # variables: 列索引或列名，例如 c(5:11)
  # h: 预测未来多少步
  # freq: 时间序列的频率，默认按日（365.25）

  # 初始化结果列表
  future_list <- list()

  for (i in variables) {
    # 取出变量时间序列
    ts_data <- ts(train_set[, i], frequency = freq)

    # 建模
    model <- nnetar(ts_data)

    # 预测
    fc <- forecast(model, h = h)

    # 存储结果
    future_list[[as.character(i)]] <- as.numeric(fc$mean)
  }

  # 合并结果成矩阵（行是时间，列是变量）
  future_matrix <- do.call(cbind, future_list)
  colnames(future_matrix) <- paste0("V", variables)

  return(future_matrix)
}



```





